<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sm.pfprod.dal.user.login.PfUserDao">

    <sql id="Base_Column_List" >
         user_id, username, password, salt, email, phone_no, enabled, is_first, role_type, role_desc,
         real_name, remark, last_login_time, is_deleted, gmt_create, gmt_modify
    </sql>

    <!-- 保存用户信息 -->
    <insert id="saveUser" parameterType="com.sm.pfprod.model.entity.UserInfo"
            keyColumn="user_id" keyProperty="userId">
        INSERT INTO user_info(
            username , password , salt , email , phone_no ,
            enabled , role_type , role_desc ,real_name , sex,
            remark , gmt_create , gmt_modify
        )
        VALUES
            (
              #{username} , #{password} , #{salt} ,  #{email} ,  #{phoneNo} ,
              #{enabled} , #{roleType} , #{roleDesc} , #{realName} , #{sex} ,
              #{remark}  , now() , now()
            );
    </insert>

    <!-- 新增用户角色 -->
    <insert id="saveUserRole">
        INSERT INTO user_role(
            user_id , role_id , is_deleted , gmt_create , gmt_modify
        )
        VALUES
        <foreach collection="list" item="item" separator="," >
            (#{userId}, #{item}, 'N' , NOW(), NOW())
        </foreach>
    </insert>

    <!-- 删除用户角色 -->
    <delete id="delUserRole">
        update user_role set is_deleted = 'Y' where user_id = #{userId}
    </delete>

    <!-- 删除用户 -->
    <update id="delUser" parameterType="java.util.List">
        UPDATE user_info SET is_deleted = 'Y', gmt_modify = now()
        WHERE
        user_id in (
        <foreach collection="list" item="item" separator="," >
            #{item}
        </foreach>
        )
    </update>

    <!-- 冻结用户 -->
    <update id="freezeUser" parameterType="java.util.List">
        UPDATE user_info SET enabled = 0, gmt_modify = now()
        WHERE
        user_id in (
        <foreach collection="list" item="item" separator="," >
            #{item}
        </foreach>
        )
    </update>

    <!-- 修改用户信息 -->
    <update id="updateUser" parameterType="com.sm.pfprod.model.entity.UserInfo">
        UPDATE user_info
        SET
            <if test="username != null">
                username = #{username} ,
            </if>
            <if test="email != null">
                email = #{email} ,
            </if>
            <if test="phoneNo != null">
                phone_no = #{phoneNo} ,
            </if>
            <if test="enabled != null">
                enabled = #{enabled} ,
            </if>
            <if test="isFirst != null">
                is_first = #{isFirst} ,
            </if>
            <if test="roleType != null">
                role_type = #{roleType} ,
            </if>
            <if test="roleDesc != null">
                role_desc = #{roleDesc} ,
            </if>
            <if test="realName != null">
                real_name = #{realName} ,
            </if>
            <if test="sex != null">
                sex = #{sex} ,
            </if>
            <if test="remark != null">
                remark = #{remark} ,
            </if>
            <if test="isDeleted != null">
                is_deleted = #{isDeleted} ,
            </if>
            gmt_modify = NOW()
        WHERE
            user_id = #{userId};
    </update>

    <!-- 修改密码 -->
    <update id="updatePsw" parameterType="com.sm.pfprod.model.entity.UserInfo">
        UPDATE user_info
        SET password = #{password}, salt = #{salt}
        WHERE user_id = #{userId}
    </update>

    <!-- 根据用户获取用户信息 -->
    <select id="selectUser" resultType="com.sm.pfprod.model.entity.UserInfo">
        SELECT
        <include refid="Base_Column_List" />
        FROM user_info
        WHERE username = #{userName}
        and is_deleted = 'N'
    </select>

    <!-- 根据用户id获取用户信息 -->
    <select id="selectUserById" resultType="com.sm.pfprod.model.entity.UserInfo">
        SELECT
        <include refid="Base_Column_List" />
        FROM user_info
        WHERE user_id = #{userId}
    </select>

    <!-- 获取用户列表 -->
    <select id="listUsers" parameterType="com.sm.pfprod.model.dto.user.PfUserDto"
            resultType="com.sm.pfprod.model.vo.user.PfUsersVo">
        SELECT
            user_id , username , email , sex , phone_no , enabled ,
            is_first , real_name , last_login_time , is_deleted , role_type,
            gmt_create
        FROM
            user_info
        <if test="conditionValue != null and conditionValue !=''">
            <trim prefix="WHERE" prefixOverrides="AND|OR">
                <choose>
                    <when test="type != null and type == '1'.toString()">
                        username like concat(#{conditionValue},'%')
                    </when>
                    <when test="type != null and type == '2'.toString()">
                        real_name like concat(#{conditionValue},'%')
                    </when>
                    <when test="type != null and type == '3'.toString()">
                        phone_no like concat(#{conditionValue},'%')
                    </when>
                </choose>
            </trim>
        </if>
        where is_deleted = 'N'
        ORDER BY user_id
        limit #{offset}, #{limit}
    </select>

    <!-- 获取用户列表总数 -->
    <select id="countUsers" parameterType="com.sm.pfprod.model.dto.user.PfUserDto" resultType="java.lang.Long">
        SELECT
        count(1)
        FROM user_info
        <if test="conditionValue != null and conditionValue !=''">
            <trim prefix="WHERE" prefixOverrides="AND|OR">
                <choose>
                    <when test="type != null and type == '1'.toString()">
                        username like concat(#{conditionValue},'%')
                    </when>
                    <when test="type != null and type == '2'.toString()">
                        real_name like concat(#{conditionValue},'%')
                    </when>
                    <when test="type != null and type == '3'.toString()">
                        phone_no like concat(#{conditionValue},'%')
                    </when>
                </choose>
            </trim>
        </if>
    </select>

    <!-- 判断是否存在相同的用户名 -->
    <select id="isExistUser" resultType="java.lang.Boolean">
         SELECT COUNT(1) FROM user_info WHERE username = #{userName} and is_deleted = 'N'
    </select>

</mapper>